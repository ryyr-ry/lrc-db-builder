name: Build lrclib synced-only DB
# lrclib 公式ダンプ → synced_lyrics 抽出 → zstd 圧縮 → GitHub Releases
#
# DB構造 (ソースコード + 実行ログ確認済み):
#   tracks (21.5M件): id, name, artist_name, album_name, duration, last_lyrics_id
#   lyrics (13.5M synced): id, synced_lyrics, track_id, has_synced_lyrics (indexed)
#
# ディスク制約:
#   ランナー: 145GB, cleanup後118GB空き
#   ダンプ: 20GB(gz) → 78GB(sqlite)
#   出力DB: 13.5M件 × ~2KB ≈ 25-30GB
#   → 78GB + 30GB = 108GB > 空き40GB (展開後)
#   → 2フェーズ方式で回避: TSV出力 → ダンプ削除 → SQLiteインポート

on:
  schedule:
    - cron: "0 6 1 * *"
  workflow_dispatch:
    inputs:
      dump_url:
        description: "lrclib dump URL"
        required: false
        default: "https://db-dumps.lrclib.net/lrclib-db-dump-20260122T091251Z.sqlite3.gz"

permissions:
  contents: write

jobs:
  build-lrclib-synced:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------
      # 1. セットアップ（並列ディスク解放 + ツール導入）
      # -------------------------------------------------------
      - name: Setup
        run: |
          echo "=== Before cleanup ==="
          df -h /

          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /usr/share/swift &
          sudo rm -rf /usr/local/share/boost &
          sudo rm -rf /usr/local/graalvm &
          sudo rm -rf /usr/local/share/chromium &
          sudo rm -rf /usr/local/share/powershell &
          sudo rm -rf /opt/hostedtoolcache &
          sudo docker system prune -af 2>/dev/null &
          wait
          sudo apt-get clean

          echo "=== After cleanup ==="
          df -h /

          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            sqlite3 aria2 isal zstd

      # -------------------------------------------------------
      # 2. ダウンロード (aria2c 16並列, ~90秒)
      # -------------------------------------------------------
      - name: Download
        run: |
          URL="${{ github.event.inputs.dump_url || 'https://db-dumps.lrclib.net/lrclib-db-dump-20260122T091251Z.sqlite3.gz' }}"
          echo "Downloading: $URL"

          WORK="$HOME/lrclib-build"
          mkdir -p "$WORK"
          echo "WORK=$WORK" >> $GITHUB_ENV

          aria2c -x 16 -s 16 --summary-interval=15 \
            -d "$WORK" -o dump.sqlite3.gz "$URL"

          ls -lh "$WORK/dump.sqlite3.gz"
          df -h /

      # -------------------------------------------------------
      # 3. 展開 (igzip in-place, ~4分)
      # -------------------------------------------------------
      - name: Decompress
        run: |
          cd "$WORK"
          echo "Decompressing with igzip (in-place)..."
          time igzip -d dump.sqlite3.gz
          ls -lh dump.sqlite3
          df -h /

      # -------------------------------------------------------
      # 4. 2フェーズ抽出
      #    ディスク制約: ダンプ78GB + 出力DB30GB > 空き40GB
      #    → Phase1: ダンプからTSVにストリーム出力
      #    → Phase2: ダンプ削除 → TSVからSQLiteビルド
      # -------------------------------------------------------
      - name: Extract and compress
        run: |
          cd "$WORK"

          # --- DB統計 ---
          echo "=== DB Stats ==="
          sqlite3 dump.sqlite3 "SELECT 'tracks: ' || COUNT(*) FROM tracks;"
          sqlite3 dump.sqlite3 "SELECT 'synced lyrics: ' || COUNT(*) FROM lyrics WHERE has_synced_lyrics = 1;"
          df -h /

          # =============================================
          # Phase 1: ダンプ → TSV (ストリーミング出力)
          #   .output でファイルに直接書き出し
          #   PRAGMA出力は stdout (ログ) に流れる
          # =============================================
          echo "Phase 1: Exporting synced lyrics to TSV..."
          time sqlite3 dump.sqlite3 <<'SQL'
          PRAGMA mmap_size=8589934592;
          PRAGMA cache_size=-2000000;
          .mode tabs
          .output synced.tsv
          SELECT t.id, t.name, t.artist_name, t.album_name, t.duration, l.synced_lyrics
            FROM lyrics l
            INNER JOIN tracks t ON t.last_lyrics_id = l.id
            WHERE l.has_synced_lyrics = 1
              AND t.name IS NOT NULL
              AND t.artist_name IS NOT NULL
              AND l.synced_lyrics IS NOT NULL;
          .output stdout
          SQL

          echo "TSV size:"
          ls -lh synced.tsv
          wc -l synced.tsv
          df -h /

          # =============================================
          # Phase 2: ダンプ削除 → SQLite ビルド
          # =============================================
          echo "Phase 2: Deleting dump to free 78GB..."
          rm -f dump.sqlite3
          df -h /

          echo "Phase 2: Building SQLite database from TSV..."
          sqlite3 lrclib_synced.db <<'SQL'
          PRAGMA synchronous=OFF;
          PRAGMA journal_mode=OFF;
          PRAGMA cache_size=-1000000;

          CREATE TABLE lyrics (
            id INTEGER PRIMARY KEY,
            track_name TEXT NOT NULL,
            artist_name TEXT NOT NULL,
            album_name TEXT,
            duration REAL,
            synced_lyrics TEXT NOT NULL
          );
          SQL

          time sqlite3 -separator "	" lrclib_synced.db ".import synced.tsv lyrics"

          echo "Building indexes..."
          time sqlite3 lrclib_synced.db <<'SQL'
          CREATE INDEX idx_artist_track ON lyrics(artist_name, track_name);
          CREATE INDEX idx_track ON lyrics(track_name);
          ANALYZE;
          SQL

          echo "Cleaning up TSV..."
          rm -f synced.tsv

          ROWS=$(sqlite3 lrclib_synced.db "SELECT COUNT(*) FROM lyrics;")
          echo "========================================"
          echo "  Synced records: $ROWS"
          echo "========================================"
          ls -lh lrclib_synced.db
          df -h /

          # =============================================
          # Phase 3: zstd 圧縮
          # =============================================
          echo "Phase 3: Compressing with zstd..."
          time zstd -19 --rm lrclib_synced.db -o lrclib_synced.db.zst

          echo "========================================"
          echo "  Compressed: $(ls -lh lrclib_synced.db.zst | awk '{print $5}')"
          echo "========================================"

      # -------------------------------------------------------
      # 5. GitHub Release
      # -------------------------------------------------------
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "lrclib-${{ github.run_id }}"
          name: "lrclib synced DB"
          body: |
            lrclib 公式ダンプから synced_lyrics のみ抽出した軽量DB。

            - テーブル: `lyrics` (id, track_name, artist_name, album_name, duration, synced_lyrics)
            - インデックス: `idx_artist_track`, `idx_track`
            - 形式: SQLite3 + zstd圧縮

            ```bash
            zstd -d lrclib_synced.db.zst
            sqlite3 lrclib_synced.db "SELECT * FROM lyrics WHERE artist_name='Kenshi Yonezu' LIMIT 5;"
            ```
          files: ${{ env.WORK }}/lrclib_synced.db.zst
