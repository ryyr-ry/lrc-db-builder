name: Build lrclib synced-only DB
# lrclib 公式ダンプ → synced_lyrics 抽出 → zstd 圧縮 → GitHub Releases
#
# DB構造 (ソースコード確認済み):
#   tracks: id, name, artist_name, album_name, duration, last_lyrics_id
#   lyrics: id, synced_lyrics, track_id, has_synced_lyrics (indexed)
#   リレーション: tracks.last_lyrics_id → lyrics.id

on:
  schedule:
    - cron: "0 6 1 * *"
  workflow_dispatch:
    inputs:
      dump_url:
        description: "lrclib dump URL"
        required: false
        default: "https://db-dumps.lrclib.net/lrclib-db-dump-20260122T091251Z.sqlite3.gz"

permissions:
  contents: write

jobs:
  build-lrclib-synced:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------
      # 1. ディスク解放 + ツール導入（並列削除で高速化）
      # -------------------------------------------------------
      - name: Setup
        run: |
          echo "=== Before cleanup ==="
          df -h /

          # 並列削除
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /usr/share/swift &
          sudo rm -rf /usr/local/share/boost &
          sudo rm -rf /usr/local/graalvm &
          sudo rm -rf /usr/local/share/chromium &
          sudo rm -rf /usr/local/share/powershell &
          sudo rm -rf /opt/hostedtoolcache &
          sudo docker system prune -af 2>/dev/null &
          wait
          sudo apt-get clean

          echo "=== After cleanup ==="
          df -h /

          # ツールインストール
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            sqlite3 aria2 isal zstd

      # -------------------------------------------------------
      # 2. ダウンロード (aria2c 16並列, ~90秒)
      # -------------------------------------------------------
      - name: Download
        run: |
          URL="${{ github.event.inputs.dump_url || 'https://db-dumps.lrclib.net/lrclib-db-dump-20260122T091251Z.sqlite3.gz' }}"
          echo "Downloading: $URL"

          WORK="$HOME/lrclib-build"
          mkdir -p "$WORK"
          echo "WORK=$WORK" >> $GITHUB_ENV

          aria2c -x 16 -s 16 --summary-interval=15 \
            -d "$WORK" -o dump.sqlite3.gz "$URL"

          ls -lh "$WORK/dump.sqlite3.gz"
          df -h /

      # -------------------------------------------------------
      # 3. 展開 (igzip in-place, ディスク安全, ~3-4分)
      #    in-place = gzが上書きされるのでピーク使用量 = 展開後サイズのみ
      # -------------------------------------------------------
      - name: Decompress
        run: |
          cd "$WORK"
          echo "Decompressing with igzip (in-place)..."
          time igzip -d dump.sqlite3.gz
          ls -lh dump.sqlite3
          df -h /

      # -------------------------------------------------------
      # 4. DB確認 + 抽出 + 圧縮（一気に実行）
      #    出力DBは tmpfs (/dev/shm) に書いてディスクI/Oを排除
      # -------------------------------------------------------
      - name: Extract and compress
        run: |
          cd "$WORK"
          OUT="$WORK/lrclib_synced.db"

          # --- DB構造確認 ---
          echo "=== Tables ==="
          sqlite3 dump.sqlite3 ".tables"
          echo "=== tracks columns ==="
          sqlite3 dump.sqlite3 "PRAGMA table_info(tracks);"
          echo "=== lyrics columns ==="
          sqlite3 dump.sqlite3 "PRAGMA table_info(lyrics);"
          echo "=== Stats ==="
          sqlite3 dump.sqlite3 "SELECT COUNT(*) AS total_tracks FROM tracks;"
          sqlite3 dump.sqlite3 "SELECT COUNT(*) AS synced_lyrics FROM lyrics WHERE has_synced_lyrics = 1;"

          # --- 高速化 PRAGMA + 抽出 ---
          echo "Extracting synced lyrics with optimized PRAGMAs..."
          time sqlite3 dump.sqlite3 <<SQL
          PRAGMA mmap_size=8589934592;
          PRAGMA cache_size=-2000000;
          PRAGMA temp_store=MEMORY;

          ATTACH DATABASE '$OUT' AS out;
          PRAGMA out.synchronous=OFF;
          PRAGMA out.journal_mode=OFF;

          CREATE TABLE out.lyrics (
            id INTEGER PRIMARY KEY,
            track_name TEXT NOT NULL,
            artist_name TEXT NOT NULL,
            album_name TEXT,
            duration REAL,
            synced_lyrics TEXT NOT NULL
          );

          INSERT INTO out.lyrics (id, track_name, artist_name, album_name, duration, synced_lyrics)
            SELECT t.id, t.name, t.artist_name, t.album_name, t.duration, l.synced_lyrics
            FROM lyrics l
            INNER JOIN tracks t ON t.last_lyrics_id = l.id
            WHERE l.has_synced_lyrics = 1
              AND t.name IS NOT NULL
              AND t.artist_name IS NOT NULL
              AND l.synced_lyrics IS NOT NULL;

          CREATE INDEX out.idx_artist_track ON lyrics(artist_name, track_name);
          CREATE INDEX out.idx_track ON lyrics(track_name);

          SELECT '========================================';
          SELECT '  Synced records: ' || COUNT(*) FROM out.lyrics;
          SELECT '========================================';
          SQL

          ls -lh "$OUT"

          # --- 元ダンプ削除 ---
          rm -f dump.sqlite3
          df -h /

          # --- ANALYZE ---
          sqlite3 "$OUT" "ANALYZE;"

          # --- zstd 圧縮 (brotliの5倍速で同等圧縮率) ---
          echo "Compressing with zstd..."
          time zstd -19 --rm "$OUT" -o "$WORK/lrclib_synced.db.zst"

          echo "========================================"
          echo "  Compressed: $(ls -lh $WORK/lrclib_synced.db.zst | awk '{print $5}')"
          echo "========================================"

      # -------------------------------------------------------
      # 5. GitHub Release
      # -------------------------------------------------------
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "lrclib-${{ github.run_id }}"
          name: "lrclib synced DB"
          body: |
            lrclib 公式ダンプから synced_lyrics のみ抽出した軽量DB。

            - テーブル: `lyrics` (id, track_name, artist_name, album_name, duration, synced_lyrics)
            - インデックス: `idx_artist_track`, `idx_track`
            - 形式: SQLite3 + zstd圧縮

            ```bash
            zstd -d lrclib_synced.db.zst
            sqlite3 lrclib_synced.db "SELECT * FROM lyrics WHERE artist_name='Kenshi Yonezu' LIMIT 5;"
            ```
          files: ${{ env.WORK }}/lrclib_synced.db.zst
