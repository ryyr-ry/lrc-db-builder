name: Build lrclib synced-only DB
# lrclib の公式ダンプから synced_lyrics のみ抽出し、
# 軽量 SQLite DB を Brotli 圧縮して GitHub Releases にアップロードする
#
# lrclib DB構造 (確認済み):
#   tracks: id, name, artist_name, album_name, duration, last_lyrics_id
#   lyrics: id, plain_lyrics, synced_lyrics, track_id (FK→tracks), has_synced_lyrics
#   → tracks と lyrics は track_id で 1:N リレーション

on:
  schedule:
    - cron: "0 6 1 * *" # 毎月1日 06:00 UTC
  workflow_dispatch: # 手動実行
    inputs:
      dump_url:
        description: "lrclib dump URL"
        required: false
        default: "https://db-dumps.lrclib.net/lrclib-db-dump-20260122T091251Z.sqlite3.gz"

permissions:
  contents: write # Release 作成に必要

jobs:
  build-lrclib-synced:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------
      # 1. ディスク容量の確保
      # -------------------------------------------------------
      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h /

          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /opt/hostedtoolcache
          sudo docker system prune -af 2>/dev/null || true
          sudo apt-get clean

          echo "=== After cleanup ==="
          df -h /

      # -------------------------------------------------------
      # 2. 必要ツールのインストール
      # -------------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq sqlite3 brotli aria2 pv isal

      # -------------------------------------------------------
      # 3. ダウンロード（aria2c 16並列）
      # -------------------------------------------------------
      - name: Set dump URL
        id: dump-url
        run: |
          URL="${{ github.event.inputs.dump_url || 'https://db-dumps.lrclib.net/lrclib-db-dump-20260122T091251Z.sqlite3.gz' }}"
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Dump URL: $URL"

      - name: Download dump
        run: |
          WORK_DIR="$HOME/lrclib-build"
          mkdir -p "$WORK_DIR"
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV

          echo "Downloading with aria2c (16 connections)..."
          aria2c -x 16 -s 16 --summary-interval=30 \
            -d "$WORK_DIR" -o dump.sqlite3.gz \
            "${{ steps.dump-url.outputs.url }}"

          ls -lh "$WORK_DIR/dump.sqlite3.gz"
          df -h /

      # -------------------------------------------------------
      # 4. 展開（igzip + pv で進捗表示）
      # -------------------------------------------------------
      - name: Decompress dump
        run: |
          cd "$WORK_DIR"
          echo "Decompressing with igzip + pv..."
          pv dump.sqlite3.gz | igzip -d > dump.sqlite3
          rm dump.sqlite3.gz
          ls -lh dump.sqlite3
          df -h /

      # -------------------------------------------------------
      # 5. DB構造確認
      # -------------------------------------------------------
      - name: Inspect DB structure
        run: |
          cd "$WORK_DIR"
          echo "=== Tables ==="
          sqlite3 dump.sqlite3 ".tables"
          echo "=== tracks columns ==="
          sqlite3 dump.sqlite3 "PRAGMA table_info(tracks);"
          echo "=== lyrics columns ==="
          sqlite3 dump.sqlite3 "PRAGMA table_info(lyrics);"
          echo "=== tracks count ==="
          sqlite3 dump.sqlite3 "SELECT COUNT(*) FROM tracks;"
          echo "=== lyrics with synced count ==="
          sqlite3 dump.sqlite3 "SELECT COUNT(*) FROM lyrics WHERE has_synced_lyrics = 1;"

      # -------------------------------------------------------
      # 6. synced lyrics 抽出（tracks JOIN lyrics）
      # -------------------------------------------------------
      - name: Extract synced-only records
        run: |
          cd "$WORK_DIR"

          echo "Extracting synced lyrics (JOIN tracks + lyrics)..."
          sqlite3 dump.sqlite3 <<'SQL'
          ATTACH DATABASE 'lrclib_synced.db' AS out;

          CREATE TABLE out.lyrics (
            id INTEGER PRIMARY KEY,
            track_name TEXT NOT NULL,
            artist_name TEXT NOT NULL,
            album_name TEXT,
            duration REAL,
            synced_lyrics TEXT NOT NULL
          );

          INSERT INTO out.lyrics (id, track_name, artist_name, album_name, duration, synced_lyrics)
            SELECT t.id, t.name, t.artist_name, t.album_name, t.duration, l.synced_lyrics
            FROM tracks t
            INNER JOIN lyrics l ON l.id = t.last_lyrics_id
            WHERE l.synced_lyrics IS NOT NULL AND l.synced_lyrics != '';

          CREATE INDEX out.idx_artist_track ON lyrics(artist_name, track_name);
          CREATE INDEX out.idx_track ON lyrics(track_name);
          SQL

          TOTAL=$(sqlite3 dump.sqlite3 "SELECT COUNT(*) FROM tracks;")
          SYNCED=$(sqlite3 lrclib_synced.db "SELECT COUNT(*) FROM lyrics;")
          echo "========================================"
          echo "  Total tracks in dump:    $TOTAL"
          echo "  Synced records extracted: $SYNCED"
          echo "========================================"
          ls -lh lrclib_synced.db

      # -------------------------------------------------------
      # 7. 元ダンプ削除 → 最適化 → 圧縮
      # -------------------------------------------------------
      - name: Remove original dump
        run: |
          rm -f "$WORK_DIR/dump.sqlite3"
          df -h /

      - name: Optimize database
        run: |
          cd "$WORK_DIR"
          sqlite3 lrclib_synced.db "VACUUM;"
          sqlite3 lrclib_synced.db "ANALYZE;"
          ls -lh lrclib_synced.db

      - name: Compress with Brotli
        run: |
          cd "$WORK_DIR"
          brotli -q 9 lrclib_synced.db -o lrclib_synced.db.br
          echo "========================================"
          echo "  Uncompressed: $(ls -lh lrclib_synced.db | awk '{print $5}')"
          echo "  Compressed:   $(ls -lh lrclib_synced.db.br | awk '{print $5}')"
          echo "========================================"

      # -------------------------------------------------------
      # 8. GitHub Release にアップロード
      # -------------------------------------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "lrclib-${{ github.run_id }}"
          name: "lrclib synced DB"
          body: |
            lrclib 公式ダンプから synced_lyrics のみ抽出した軽量DB。

            - ソース: ${{ steps.dump-url.outputs.url }}
            - テーブル: `lyrics` (id, track_name, artist_name, album_name, duration, synced_lyrics)
            - インデックス: `idx_artist_track(artist_name, track_name)`, `idx_track(track_name)`

            ```
            brotli -d lrclib_synced.db.br
            sqlite3 lrclib_synced.db "SELECT * FROM lyrics WHERE artist_name='Kenshi Yonezu' LIMIT 5;"
            ```
          files: ${{ env.WORK_DIR }}/lrclib_synced.db.br
